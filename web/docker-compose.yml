services:
  pocketbase:
    image: ghcr.io/muchobien/pocketbase:latest
    container_name: movie-generator-pocketbase
    restart: unless-stopped
    volumes:
      - ./pocketbase/pb_data:/pb_data
      - ./pocketbase/pb_migrations:/pb_migrations
    ports:
      - "8090:8090"
    environment:
      - POCKETBASE_ADMIN_EMAIL=${POCKETBASE_ADMIN_EMAIL:-admin@example.com}
      - POCKETBASE_ADMIN_EMAIL=${POCKETBASE_ADMIN_EMAIL:-admin@example.com}
      - PB_ADMIN_EMAIL=${PB_ADMIN_EMAIL:-admin@example.com}
      - PB_ADMIN_PASSWORD=${PB_ADMIN_PASSWORD:-changeme123}
    healthcheck:
      test: ["CMD", "wget", "--spider", "-q", "http://localhost:8090/api/health"]
      interval: 10s
      timeout: 5s
      retries: 3
    networks:
      - movie-generator-network

  api:
    build:
      context: ..
      dockerfile: web/api/Dockerfile
    container_name: movie-generator-api
    restart: unless-stopped
    depends_on:
      pocketbase:
        condition: service_healthy
    volumes:
      - ./data/jobs:/app/data/jobs
    environment:
      - POCKETBASE_URL=http://pocketbase:8090
      - OPENROUTER_API_KEY=${OPENROUTER_API_KEY}
      - MAX_QUEUE_SIZE=${MAX_QUEUE_SIZE:-10}
      - RATE_LIMIT_PER_DAY=${RATE_LIMIT_PER_DAY:-5}
      - MAX_VIDEO_DURATION_MINUTES=${MAX_VIDEO_DURATION_MINUTES:-5}
    ports:
      - "0.0.0.0:8000:8000"  # Listen on all interfaces including Tailscale
    # labels:
    #   - "traefik.enable=true"
    #   - "traefik.http.routers.movie-generator.rule=Host(`${DOMAIN:-movie.example.com}`)"
    #   - "traefik.http.routers.movie-generator.entrypoints=websecure"
    #   - "traefik.http.routers.movie-generator.tls.certresolver=letsencrypt"
    #   - "traefik.http.services.movie-generator.loadbalancer.server.port=8000"
    networks:
      - movie-generator-network
      # - traefik-network  # Uncomment for production with Traefik

  worker:
    build:
      context: ..
      dockerfile: web/worker/Dockerfile
    container_name: movie-generator-worker
    restart: unless-stopped
    depends_on:
      pocketbase:
        condition: service_healthy
    volumes:
      - ./data/jobs:/app/data/jobs
      - ../assets:/app/assets:ro  # Mount assets directory
      - ~/.local/share/voicevox:/opt/voicevox:ro  # Mount local VOICEVOX
    environment:
      - POCKETBASE_URL=http://pocketbase:8090
      - OPENROUTER_API_KEY=${OPENROUTER_API_KEY}
      # VOICEVOX environment variables are set in Dockerfile
      - MAX_CONCURRENT_JOBS=${MAX_CONCURRENT_JOBS:-2}
      - WORKER_POLL_INTERVAL=${WORKER_POLL_INTERVAL:-5}
      # Required for proper asset path detection
      - DOCKER_ENV=true
      # Config file for persona pool and other settings
      - CONFIG_PATH=/app/web/config/config.yaml
    networks:
      - movie-generator-network

networks:
  movie-generator-network:
    driver: bridge
  # traefik-network:  # Uncomment for production
  #   external: true
