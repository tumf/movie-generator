# ジョブキャンセル機能の追加

## 概要

ユーザーが待機中（pending）または処理中（processing）のジョブをキャンセルできる機能を追加します。
これにより、不要になったジョブや誤って作成したジョブをユーザーが手動で停止できるようになります。

## 背景

現状、一度ジョブを作成すると、ユーザーはそのジョブを停止する手段がありません。
以下の場合にキャンセル機能が必要です：

1. 誤ったURLでジョブを作成してしまった
2. 想定より処理時間が長く、別のURLで試したい
3. キューに多数のジョブが溜まっており、不要なジョブを削除したい

## 目標

1. **UI**: ジョブ詳細ページにキャンセルボタンを追加
2. **API**: ジョブをキャンセルするエンドポイントを提供
3. **Worker**: 処理中のジョブに対しても安全にキャンセルを適用
4. **UX**: キャンセル後は適切なメッセージを表示

## 対象範囲

### 含まれる機能

- `pending` ステータスのジョブのキャンセル（即座にステータス変更）
- `processing` ステータスのジョブのキャンセル（現在の処理完了を待たずに停止）
- Web UIにキャンセルボタンの追加
- キャンセル確認ダイアログの表示
- キャンセル後の適切なフィードバック

### 含まれない機能

- `completed` または `failed` ステータスのジョブのキャンセル
- ジョブの一時停止・再開機能
- バッチキャンセル（複数ジョブの一括キャンセル）

## 利害関係者

- **ユーザー**: 不要なジョブを停止できることでリソースを節約
- **システム**: 無駄な処理を削減し、キューの効率を向上

## 制約事項

1. キャンセル可能なステータスは `pending` と `processing` のみ
2. 処理中のジョブは現在のサブタスク完了後にキャンセル（即座の強制終了はしない）
3. キャンセルされたジョブの部分的な成果物は削除

## 成功基準

1. ユーザーが `pending` ジョブをキャンセルでき、即座に `cancelled` ステータスになる
2. ユーザーが `processing` ジョブをキャンセルでき、Workerが処理を停止する
3. キャンセルボタンは適切なステータスのジョブでのみ表示される
4. キャンセル操作には確認ダイアログが表示される

## 影響を受けるコンポーネント

- `web/api/routes/api_routes.py` - 新規APIエンドポイント
- `web/api/pocketbase_client.py` - キャンセル用メソッド追加
- `web/api/templates/partials/job_status.html` - キャンセルボタンUI
- `web/worker/main.py` - キャンセル検出ロジック
- `openspec/specs/web-interface/spec.md` - 仕様更新

## リスクと軽減策

### リスク1: 処理中ジョブのキャンセルによるリソースリーク
- **軽減策**: Workerは各ステップでキャンセル状態をチェックし、適切にクリーンアップ

### リスク2: 同時実行による競合状態
- **軽減策**: Pocketbaseの楽観的ロックを利用し、ステータス遷移の整合性を保証

## 代替案

### 代替案1: 自動タイムアウト機能
- 一定時間経過後に自動キャンセル
- **却下理由**: ユーザーの明示的な操作による柔軟性が優先

### 代替案2: キャンセル後の再利用
- キャンセルされたジョブを編集して再実行
- **却下理由**: 実装複雑度が高い。新規作成で対応可能

## 関連する変更

- 既存: `update-realtime-progress` - 進捗表示の改善
- 将来: バッチ操作機能 - 複数ジョブの一括管理

## 参考資料

- Pocketbase API Documentation: https://pocketbase.io/docs/api-records/
- HTMXパターン: https://htmx.org/examples/confirm/
