# 設計: コードベース構造のリファクタリング

## コンテキスト

Movie Generatorプロジェクトは、ブログURLからYouTube動画を自動生成するCLIツールです。
コードベースの成長に伴い、以下の技術的負債が蓄積されています：

- 重複コードパターン（ファイルチェック、リトライ、サブプロセス実行）
- 長大な関数（cli.pyのgenerate関数が409行）
- マジックナンバー/文字列の散在
- 不統一なエラーハンドリング
- 型安全性の不足

### ステークホルダー
- 開発者（保守性向上）
- ユーザー（エラーメッセージの改善）

### 制約
- 後方互換性の維持（APIの変更なし）
- テストスイートの継続的パス
- 段階的な実装（一度に全体を変更しない）

## ゴール / 非ゴール

### ゴール
- コード重複の削減（DRY原則）
- 関数の単一責任化
- エラーハンドリングの統一
- 型安全性の向上
- 保守性・テスト容易性の改善

### 非ゴール
- 機能追加
- パフォーマンス最適化
- API変更
- 依存関係の大幅な変更

## 設計決定

### 決定1: ユーティリティモジュールの構成

**選択**: `src/movie_generator/utils/` パッケージとして整理

**理由**:
- 機能別に分離することで発見容易性向上
- 単体テストが容易
- 将来的な拡張に対応

**代替案**:
- 単一の `utils.py` ファイル → ファイルが肥大化する恐れ
- 各モジュールに inline で配置 → 重複が解消されない

**構成**:
```
utils/
├── __init__.py      # 公開APIのエクスポート
├── filesystem.py    # ファイル操作
├── retry.py         # リトライロジック
├── subprocess.py    # サブプロセス実行
└── text.py          # テキスト処理
```

### 決定2: 定数管理

**選択**: `constants.py` に集約、クラスベースでグループ化

**理由**:
- IDEの補完が効く
- 関連する定数をグループ化
- ドキュメント化が容易

**代替案**:
- 各モジュールに定数定義 → 重複、不整合のリスク
- 環境変数 → 固定値には不適切

**構成**:
```python
class VideoConstants:
    DEFAULT_FPS = 30
    DEFAULT_WIDTH = 1920
    DEFAULT_HEIGHT = 1080

class FileExtensions:
    YAML = {".yaml", ".yml"}
    IMAGE = {".png", ".jpg", ".jpeg"}
```

### 決定3: 例外階層

**選択**: ベース例外クラスから派生するカスタム例外

**理由**:
- 例外の種類を明確化
- キャッチの粒度を制御可能
- エラーメッセージの一貫性

**代替案**:
- 標準例外のみ使用 → 区別が困難
- エラーコードベース → Pythonのイディオムに反する

**階層**:
```
MovieGeneratorError
├── ConfigurationError    # 設定ファイル、環境変数
├── RenderingError        # 動画レンダリング
├── MCPError              # MCP通信
└── ContentFetchError     # コンテンツ取得
```

### 決定4: CLI関数の分割方針

**選択**: パイプラインステップごとに関数を分割

**理由**:
- 各ステップが独立してテスト可能
- エラー発生箇所の特定が容易
- 再利用性の向上

**分割単位**:
1. `_load_or_create_script()` - スクリプト読み込み/生成
2. `_generate_audio_files()` - 音声合成
3. `_generate_slides_files()` - スライド生成
4. `_render_video()` - 動画レンダリング

### 決定5: 型安全性の向上方針

**選択**: TypedDictを活用、Protocol は最小限

**理由**:
- JSON構造にはTypedDictが適切
- 既存コードへの影響を最小化
- 段階的な導入が可能

**代替案**:
- dataclass → JSON変換が必要
- Pydantic → 既に使用中だが、内部データ構造には過剰

## リスク / トレードオフ

### リスク1: リファクタリング中のバグ導入
**緩和策**:
- 各フェーズ後にテストスイート実行
- 小さな変更を段階的にコミット
- レビュー必須

### リスク2: インポートサイクル
**緩和策**:
- ユーティリティモジュールは他モジュールをインポートしない
- 依存関係の方向を明確化

### リスク3: 過度な抽象化
**緩和策**:
- 3箇所以上で使用されるパターンのみ抽出
- シンプルな関数を優先

## マイグレーションプラン

### フェーズ1: ユーティリティ抽出（影響小）
1. 新規ユーティリティモジュール作成
2. 既存コードを段階的に置換
3. 旧コードは削除

### フェーズ2: 定数集約（影響小）
1. 定数モジュール作成
2. マジックナンバーを定数に置換
3. テストで値の一貫性確認

### フェーズ3: 例外整理（影響中）
1. カスタム例外定義
2. 既存例外を段階的に置換
3. エラーメッセージの改善

### フェーズ4: CLI分割（影響中）
1. ヘルパー関数を抽出
2. generate()関数をリファクタリング
3. E2Eテストで動作確認

### ロールバック
各フェーズは独立しており、問題発生時は該当コミットのrevertで対応可能

## 未解決の質問

1. ~~ユーティリティ関数のログレベルは？~~ → 既存の`print`/`console`パターンを維持
2. ~~テストのモック方針は？~~ → 既存パターンを踏襲
3. VoicevoxのProtocol定義は必要か？ → フェーズ6で検討

## 参考資料

- [Python Best Practices](https://docs.python-guide.org/)
- [PEP 585 - Type Hinting Generics In Standard Collections](https://peps.python.org/pep-0585/)
- [Refactoring: Improving the Design of Existing Code](https://refactoring.com/)
