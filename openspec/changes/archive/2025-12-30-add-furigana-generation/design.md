# Design: 形態素解析による自動ふりがな生成

## 技術選定

### 形態素解析ライブラリ

| ライブラリ | メリット | デメリット | 選定 |
|-----------|---------|-----------|------|
| **fugashi** | 高速（Cython）、Python的API、UniDic統合 | 外部辞書必要 | **採用** |
| Janome | 依存ゼロ、インストール簡単 | 辞書が古い、速度が遅い | - |
| SudachiPy | 最新辞書、正規化機能 | x86専用wheels | - |
| mecab-python3 | 実績あり | API古い | - |

**選定理由**: fugashiは高速かつPython的なAPIを提供し、UniDic辞書との統合が優秀。

### 辞書選定

| 辞書 | サイズ | 精度 | 選定 |
|------|-------|------|------|
| unidic-lite | ~100MB | 標準 | - |
| **unidic** | ~1GB | 高い | **採用** |

**選定理由**: フル版UniDicは語彙が豊富で、専門用語や固有名詞の読みも正確。

## アーキテクチャ

### コンポーネント構成

```
┌─────────────────────────────────────────────────────────────┐
│                    VoicevoxSynthesizer                      │
├─────────────────────────────────────────────────────────────┤
│  enable_furigana: bool                                      │
│  prepare_phrases(phrases) → 辞書に自動登録                   │
│                                                             │
│  ┌──────────────────┐    ┌─────────────────────────────┐   │
│  │ FuriganaGenerator │    │  PronunciationDictionary    │   │
│  ├──────────────────┤    ├─────────────────────────────┤   │
│  │ analyze(text)    │───▶│ add_from_morphemes(readings)│   │
│  │ get_readings_dict│    │ entries: {surface: reading} │   │
│  │ analyze_texts()  │    │                             │   │
│  └──────────────────┘    └─────────────────────────────┘   │
│          │                           │                      │
│          ▼                           ▼                      │
│  ┌──────────────────┐    ┌─────────────────────────────┐   │
│  │ fugashi.Tagger   │    │   VOICEVOX UserDict API     │   │
│  │ (UniDic辞書)     │    │                             │   │
│  └──────────────────┘    └─────────────────────────────┘   │
└─────────────────────────────────────────────────────────────┘
```

### 処理フロー

1. **初期化時**: `VoicevoxSynthesizer` 作成時に `enable_furigana=True` を設定
2. **前処理**: `prepare_phrases()` で全フレーズを一括解析
3. **辞書登録**: 形態素解析結果を `PronunciationDictionary` に自動登録（priority=5）
4. **VOICEVOX初期化**: `initialize()` で辞書をVOICEVOXに渡す
5. **音声合成**: 登録された読みに基づいて正確な発音で合成

### 優先順位の設計

```
Manual/LLM entries (priority=10)  ← 最優先: ユーザー指定
         ↓
Morpheme analysis (priority=5)    ← 補完: 自動生成
         ↓
VOICEVOX default                  ← フォールバック
```

**設計意図**:
- 手動で指定した読みは常に優先される
- 形態素解析は「穴埋め」として機能し、指定のない単語をカバー
- 最終的にVOICEVOXのデフォルト動作がフォールバック

## 設定

```yaml
audio:
  enable_furigana: true  # 形態素解析による自動ふりがな生成を有効化
```

## パフォーマンス考慮

### 初期化コスト

- UniDic辞書ロード: 初回のみ、約2-3秒
- 形態素解析: テキスト1000文字あたり約10ms

### メモリ使用量

- UniDic辞書: 約500MB（メモリマップ使用）
- 形態素解析結果: テキスト量に比例（通常は無視できるレベル）

### 最適化

- **遅延初期化**: `FuriganaGenerator` は初回使用時にのみ初期化
- **一括処理**: `prepare_phrases()` で全フレーズを一度に処理
- **重複排除**: 同じ単語は1回のみ辞書に登録

## 制限事項

1. **英単語のカタカナ変換**: UniDicに登録されていない英単語はそのまま返される
   - 対策: LLM生成の発音辞書と組み合わせて使用
2. **固有名詞**: 人名・地名など一部の固有名詞は辞書にない場合がある
   - 対策: 手動の発音辞書エントリで補完
3. **辞書サイズ**: UniDicフル版は約1GBのダウンロードが必要
   - 初回のみ自動ダウンロード
