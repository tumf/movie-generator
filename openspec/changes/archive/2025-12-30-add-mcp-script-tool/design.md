# Design Document: MCP連携による台本生成拡張

## Context

現在の台本生成は静的コンテンツのみを使用していますが、MCPプロトコルを通じて外部ツール（Firecrawl、Context7など）にアクセスすることで、動的に最新情報を取得し、より充実した台本を生成できるようになります。

制約:
- MCP設定ファイルは複数の形式（JSON、JSONC）をサポートする必要がある
- MCPサーバーとの通信は非同期で行う
- MCP機能はオプションであり、指定がない場合は従来通りの動作を維持

## Goals / Non-Goals

**Goals:**
- CLI経由でMCP設定ファイルパスを指定可能にする
- Firecrawl等のMCPサーバーを使ってウェブコンテンツを取得できるようにする
- 既存の台本生成フローを壊さない

**Non-Goals:**
- すべてのMCPサーバーを完全サポート（まずはFirecrawlに焦点）
- MCP設定の自動検出（明示的な指定のみ）
- MCPサーバーの起動管理（ユーザーが事前に設定していることを前提）

## Decisions

### 1. MCP設定ファイル読み込み

**決定:** 3つの主要形式をサポート
- `opencode.jsonc` - JSONC形式（コメント付きJSON）
- `~/.cursor/mcp.json` - JSON形式
- `~/Library/Application Support/Claude/claude_desktop_config.json` - JSON形式

すべての形式で `{env:VAR_NAME}` 形式の環境変数参照をサポート

**理由:** これらは主要なAIツールで使用されている標準的な設定ファイル。環境変数参照はOpenCodeの実装に合わせて統一性を確保

**代替案:**
- 独自の設定形式を作る → 却下（車輪の再発明）
- YAML形式にする → 却下（既存エコシステムとの互換性低い）

### 2. MCPクライアント実装方法

**決定:** Python MCPライブラリ（`mcp` パッケージ）を使用

**理由:**
- 公式サポートのライブラリ
- 非同期通信対応
- エラーハンドリングが充実

**代替案:**
- 自前でプロトコル実装 → 却下（保守コスト高い）
- HTTPクライアント直接使用 → 却下（抽象化不足）

### 3. CLI引数設計

**決定:** `--mcp-config <path>` オプションを追加、指定がない場合はMCP機能を使用しない

```bash
movie-generator generate --url https://example.com --mcp-config opencode.jsonc
```

**理由:**
- 明示的で分かりやすい
- 既存動作への影響がゼロ
- 複数の設定ファイルを試しやすい

**代替案:**
- 自動検出 → 却下（予期しない動作を避ける）
- 環境変数 → 却下（CLIオプションの方が柔軟）

### 4. 台本生成時のMCP利用フロー

```
1. ユーザーがURLと--mcp-configを指定
2. MCP設定ファイルを読み込み
3. Firecrawlツールを呼び出してコンテンツ取得
4. 既存のgenerate_script()に渡す
5. LLMで台本生成
```

**決定:** `generate_script()` の前段階でMCPツールを使ってコンテンツを取得

**理由:**
- 責任の分離（コンテンツ取得 vs 台本生成）
- 既存コードの変更を最小限に
- テスタビリティ向上

## Risks / Trade-offs

### Risk 1: MCP設定ファイルのフォーマットエラー

**軽減策:** Pydanticで厳密なバリデーション、詳細なエラーメッセージ

### Risk 2: MCPサーバーとの通信失敗

**軽減策:**
- タイムアウト設定（デフォルト30秒）
- リトライロジック（最大3回）
- フォールバック動作（MCP失敗時は元のURLフェッチに戻る）

### Risk 3: セキュリティ（APIキー漏洩）

**軽減策:**
- MCP設定ファイルを `.gitignore` に追加するよう警告
- 環境変数参照形式（`{env:FIRECRAWL_API_KEY}`）をサポート
  - OpenCodeと同じ形式で統一
  - 再帰的に全てのstring値を走査して置換
  - 未定義変数は明確なエラーメッセージで通知

## Migration Plan

1. **Phase 1:** MCP設定読み込み＋基本的なクライアント実装
2. **Phase 2:** Firecrawlツールとの統合
3. **Phase 3:** テスト追加＋ドキュメント更新

**ロールバック:** `--mcp-config` オプションを使わなければ既存動作のまま

## Open Questions

- Q1: Firecrawl以外のMCPツール（Context7など）も初期実装に含めるか？
  - A: まずはFirecrawlのみ。需要があれば拡張
- Q2: MCP設定の一部（特定サーバーのみ）を使う機能は必要か？
  - A: v1では全体を読み込み、Firecrawlのみ使用。将来的にフィルター機能追加可能
